# äº¤æ˜“æœºå™¨äººä¼˜åŒ–æƒ³æ³•æ–‡æ¡£

## ğŸ“‹ æ–‡æ¡£è¯´æ˜
æˆ‘è¿›ä¸€æ­¥ç²¾ç‚¼äº†æç¤ºè¯ï¼Œèšç„¦äº SL æ”¾ç½®åœ¨æ›´é«˜æ—¶é—´æ¡†æ¶ï¼ˆHigher TFï¼Œå¦‚ 4h/1dï¼‰çš„ CHOCH-BOS ç»“æ„ç ´åç‚¹ï¼Œä»¥å®ç°é«˜ R:R äº¤æ˜“ã€‚åŒæ—¶ï¼Œæ·»åŠ ä¼˜å…ˆçº§é€»è¾‘ï¼šå¦‚æœç»“æ„å¤±æ•ˆç‚¹æ¥è¿‘å…³é”®ä»·æ ¼ï¼ˆe.g., OB/FVG/æµåŠ¨æ€§æ°´å¹³ < æ¿€æ´»é˜ˆå€¼è·ç¦»ï¼‰ï¼Œåˆ™ä¼˜å…ˆç”¨å…³é”®ä»·æ ¼ä½œä¸º SLï¼Œè¿™èƒ½â€œå€ŸåŠ›â€æ”¯æ’‘/é˜»åŠ›ï¼Œç´§ç¼©é£é™©å¹¶æ”¾å¤§ R:Rï¼ˆç›®æ ‡ 1:3+ï¼‰ã€‚å…³é”®å˜åŒ–ï¼šSMC æ•°æ®æ‰©å±•ï¼šæ–°å¢ "higher_tf_choch_bos_invalidation"ï¼ˆæ›´é«˜ TF å¤±æ•ˆä»·ï¼‰å’Œ "nearest_key_level"ï¼ˆæœ€è¿‘å…³é”®ä»·ï¼Œç”¨äºä¼˜å…ˆçº§ï¼‰ã€‚
Rules æ›´æ–°ï¼šæ˜ç¡® SL = Higher TF CHOCH-BOS ç ´åç‚¹ï¼›ä¼˜å…ˆå…³é”®ä»·å¦‚æœè·ç¦» < {activation_threshold}ï¼›TP ç„å‡†ä¸‹ä¸€ä¸ªæ›´é«˜ TF ç»“æ„ã€‚
HOLD å¼ºåŒ–ï¼šå¦‚æœè°ƒæ•´å R:R ä» < é˜ˆå€¼ï¼Œå¼ºåˆ¶ HOLDã€‚
R:R è®¡ç®—ï¼šAI éœ€éšå¼éªŒè¯ï¼ˆe.g., risk = |entry - SL|ï¼Œreward = |TP - entry| >= {rr_min_threshold} Ã— riskï¼‰ã€‚

ç›´æ¥æ›¿æ¢ä»£ç ä¸­ analyze_with_deepseek çš„ prompt å˜é‡ã€‚è®°å¾—åœ¨ä»£ç ä¸­è®¡ç®—è¿™äº›å­—æ®µï¼ˆe.g., ä» multi_tf_data[higher_tf_bias_tf] æå– swing ç‚¹ï¼‰ã€‚

You are a professional crypto trader specializing in SMC/ICT strategies for {symbol}. Analyze the provided market data and generate a high-conviction trading signal. Consider multi-timeframe alignment (higher TF bias on {higher_tf_bias_tf}, entry on {lower_tf_entry_tf}), SMC structures (CHOCH for reversal on higher TF, then BOS for confirmation; SL at higher TF CHOCH-BOS invalidation for high RR, prioritize nearest key level if close). Only trade if volume > {volume_confirmation_threshold}x MA and fresh zones (interactions <= {max_zone_interactions}).

Market Snapshot (JSON):
{{
    "current_price": {current_price},
    "activated_level": "{activated_level}",
    "timestamp": "{timestamp}",
    "primary_tf": "{primary_timeframe}",
    "technical_indicators": {{
        "rsi": {rsi:.2f},
        "macd": {{"line": {macd_line:.4f}, "signal": {macd_signal:.4f}, "histogram": {macd_histogram:.4f}}},
        "atr": {atr:.2f},
        "ema_20": {ema_20:.2f},
        "ema_100": {ema_100:.2f},
        "volume_confirmation": {volume_confirmation:.2f}x MA
    }},
    "mtf_summary": {{
        "{higher_tf_bias_tf}": "{higher_tf_trend} (strength: {higher_tf_strength:.2f})",
        "{primary_timeframe}": "{primary_tf_trend} (strength: {primary_tf_strength:.2f})",
        "{lower_tf_entry_tf}": "{lower_tf_trend} (strength: {lower_tf_strength:.2f})",
        "consistency": {mtf_consistency:.2f}
    }},
    "smc_structures": {{
        "bos_choch": "{smc_bos_choch}",
        "ob_fvg": "{smc_ob_fvg}",
        "structure_score": {structure_score:.2f},
        "fresh_zones": {fresh_zones},
        "higher_tf_choch_bos_invalidation": {higher_tf_invalidation_price},
        "nearest_key_level": {nearest_key_level},
        "key_level_distance": {key_level_distance:.4f}
    }},
    "risk_context": {{
        "volatility": {volatility:.1f}%,
        "kill_zone_active": {kill_zone_active},
        "suggested_leverage": {leverage},
        "min_rr": {rr_min_threshold},
        "activation_threshold": {activation_threshold}
    }}
}}

Rules:
- BUY: Bullish MTF alignment + bullish SMC (e.g., bullish CHOCH first for reversal on {higher_tf_bias_tf}, then BOS up for confirmation + FVG support) + RSI <70 + positive MACD histogram. SL at higher TF CHOCH low or BOS invalidation below (structure break point); if nearest key level within {activation_threshold} distance, prioritize it for tighter risk. TP at next higher TF liquidity/OB (ensure RR >= {rr_min_threshold}:1, e.g., 3x risk).
- SELL: Bearish MTF alignment + bearish SMC (e.g., bearish CHOCH first for reversal on {higher_tf_bias_tf}, then BOS down for confirmation + OB resistance) + RSI >30 + negative MACD histogram. SL at higher TF CHOCH high or BOS invalidation above (structure break point); if nearest key level within {activation_threshold} distance, prioritize it for tighter risk. TP at next higher TF liquidity/FVG (ensure RR >= {rr_min_threshold}:1, e.g., 3x risk).
- HOLD: No clear alignment (e.g., missing higher TF CHOCH-BOS sequence) or adjusted RR < {rr_min_threshold}:1 (e.g., invalidation too far even after key level prioritization).
- Set SL/TP realistically: Use higher_tf_choch_bos_invalidation for base SL (ATR-adjusted); override with nearest_key_level if key_level_distance < {activation_threshold}; TP based on next structure for high RR.

Return ONLY a valid JSON object:
{{
    "signal": "BUY" or "SELL" or "HOLD",
    "entry_price": {current_price},
    "stop_loss": number (e.g., prioritized key level below entry for BUY),
    "take_profit": number (e.g., next OB + {rr_min_threshold}x risk for BUY),
    "confidence": "LOW" or "MEDIUM" or "HIGH",
    "reason": "brief explanation (1-2 sentences, reference higher TF CHOCH-BOS invalidation, key level prioritization, and calculated RR)"
}}

å˜åŒ–è§£é‡Šä¸é¢„æœŸæ”¶ç›Šæ›´é«˜ TF ç„¦ç‚¹ï¼šSL é»˜è®¤åŸºäº {higher_tf_bias_tf}ï¼ˆe.g., 4hï¼‰çš„ CHOCH-BOS ç ´åç‚¹ï¼ˆæ–°å¢ "higher_tf_choch_bos_invalidation"ï¼‰ï¼Œè¿™æ•æ‰å¤§å‘¨æœŸç»“æ„å¤±æ•ˆï¼Œå‡å°‘å° TF å™ªéŸ³ï¼Œç¡®ä¿äº¤æ˜“â€œè·¨æ¡†æ¶â€ä¸€è‡´ã€‚é«˜ R:R æ¥è‡ªç´§ç¼© SLï¼ˆç»“æ„ç‚¹é€šå¸¸ 1-3% é£é™©ï¼‰ï¼ŒTP ç„å‡†æ›´é«˜ TF ç›®æ ‡ï¼ˆe.g., ä¸‹ä¸€ä¸ª daily OBï¼‰ã€‚
å…³é”®ä»·æ ¼ä¼˜å…ˆï¼šå¦‚æœ "key_level_distance" < {activation_threshold}ï¼ˆe.g., 0.02%ï¼‰ï¼ŒAI ä¼šç”¨ "nearest_key_level" è¦†ç›– SLï¼ˆe.g., BUY æ—¶ç”¨ä¸‹æ–¹ FVG mid ä½œä¸º SLï¼‰ã€‚è¿™â€œå€ŸåŠ¿â€å…³é”®æ°´å¹³ï¼Œæé«˜èƒœç‡ï¼ˆæ”¯æ’‘æ›´å¼ºï¼‰ã€‚
R:R éªŒè¯ï¼šè§„åˆ™ä¸­è¦æ±‚â€œensure RR >= {rr_min_threshold}:1â€ï¼ŒAI ç†ç”±ä¼šå¼•ç”¨è®¡ç®—ï¼ˆe.g., â€œSL at 4h CHOCH invalidation (prioritized key level), RR 1:3.2â€ï¼‰ï¼Œä¾¿äºæ—¥å¿—å®¡è®¡ã€‚
æ•´ä½“ï¼šäº¤æ˜“æ›´â€œæ™ºèƒ½ä¸å¯¹ç§°â€â€”â€”å°é£é™©ï¼ˆç»“æ„+å…³é”®ç‚¹ï¼‰å¤§å¥–åŠ±ï¼ˆæ›´é«˜ TF ç›®æ ‡ï¼‰ã€‚å›æµ‹ä¸­ï¼Œè¿™å¯èƒ½å°†å¹³å‡æŒä»“æ—¶é—´å»¶é•¿ï¼ˆç­‰ç¡®è®¤ï¼‰ï¼Œä½† R:R æå‡ 50%+ï¼Œé€‚åˆè¶‹åŠ¿å¸‚åœºã€‚

ä»£ç é›†æˆå»ºè®®åœ¨ analyze_with_deepseek å‰ï¼Œæ‰©å±•å¤±æ•ˆç‚¹è®¡ç®—ï¼ˆ~30 è¡Œï¼ŒåŸºäº calculate_key_levelsï¼‰ï¼špython

# ç¤ºä¾‹ï¼šåœ¨ _fetch_and_update_data å
higher_tf = config.higher_tf_bias_tf
df_higher = multi_tf_data.get(higher_tf, pd.DataFrame())
if not df_higher.empty:
    # ç®€å• CHOCH-BOS å¤±æ•ˆæ£€æµ‹ï¼ˆæ‰©å±•ä¸ºå®Œæ•´ swing/ç»“æ„ï¼‰
    swing_lows = df_higher['low'].rolling(window=config.smc_window).min()  # CHOCH ä½ç‚¹
    swing_highs = df_higher['high'].rolling(window=config.smc_window).max()  # BOS é«˜ç‚¹
    higher_tf_invalidation = swing_lows.iloc[-1] if 'BUY' in potential_signal else swing_highs.iloc[-1]  # åŠ¨æ€åŸºäºä¿¡å·
    # æœ€è¿‘å…³é”®ä»·ï¼ˆä» key_levelsï¼‰
    key_levels = self.calculate_key_levels(multi_tf_data)
    nearest_key = min(key_levels.values(), key=lambda p: abs(current_price - p))  # æœ€è¿‘ä»·
    key_distance = abs(current_price - nearest_key) / current_price
else:
    higher_tf_invalidation = current_price * 0.98  # Fallback
    nearest_key = current_price * 0.98
    key_distance = 0.02

# å¡«å……åˆ° price_data['smc_structures']
price_data['smc_structures'].update({
    'higher_tf_choch_bos_invalidation': higher_tf_invalidation,
    'nearest_key_level': nearest_key,
    'key_level_distance': key_distance
})

è°ƒç”¨ï¼šé›†æˆåˆ°ä¿¡å·ç”Ÿæˆå‰ï¼Œç¡®ä¿åŠ¨æ€ã€‚
æµ‹è¯•ï¼šç”¨å†å²æ•°æ®æ¨¡æ‹Ÿï¼ˆe.g., å›æµ‹ä¸­éªŒè¯ SL æ˜¯å¦åœ¨ 4h ç»“æ„ç‚¹ï¼‰ã€‚

